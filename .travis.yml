language: cpp

branches:
  except:
    - i18n-master

matrix:
  include:
    - os: linux
      compiler: gcc
      addons:
        apt:
          packages:
            - libasound2-dev
            - libbz2-dev
            - libcdio-paranoia-dev
            - libcurl4-openssl-dev
            - libexpat1-dev
            - libfribidi-dev
            - libgtk-3-dev
            - libjpeg-dev
            - libudev-dev
            - liburiparser-dev
            - libxml2-dev

    - os: linux
      compiler: clang
      addons:
        apt:
          packages:
            - libasound2-dev
            - libbz2-dev
            - libcdio-paranoia-dev
            - libcurl4-openssl-dev
            - libexpat1-dev
            - libfribidi-dev
            - libgtk-3-dev
            - libjpeg-dev
            - libudev-dev
            - liburiparser-dev
            - libxml2-dev
            - libcdio-paranoia1
            - libasound2
            - liburiparser1
            - libav-tools
            - libmp3lame0
            - libmpg123-0
            - libfaac0
            - libfdk-aac0
            - libfaad2
            - libflac8
            - libmp4v2-2
            - libogg0
            - libopus0
            - librubberband2
            - libsamplerate0
            - libsndfile1
            - libspeex1
            - libvorbis0a
            - libvorbisenc2
            - musepack-tools
            - wavpack

    - os: osx
      compiler: gcc

    - os: osx
      compiler: clang

before_install:
  - if [ $TRAVIS_OS_NAME = osx ]; then brew install libcdio; fi
  - if [ $TRAVIS_OS_NAME = osx ]; then wget https://ftp.gnu.org/gnu/libcdio/libcdio-paranoia-10.2+0.94+2.tar.gz && tar xfz libcdio-paranoia-10.2+0.94+2.tar.gz && cd libcdio-paranoia-10.2+0.94+2 && ./configure --prefix=/usr/local && make && sudo make install && cd ..; fi

install:
  - git clone https://github.com/enzo1982/smooth.git enzo1982/smooth && cd enzo1982/smooth && make && sudo make install prefix=/usr && cd ../..
  - git clone https://github.com/enzo1982/boca.git enzo1982/boca && cd enzo1982/boca && make && sudo make install prefix=/usr && cd ../..

script:
  - sed -i -e 's|/usr/local|/usr|g' Makefile-options
  - make -j$(nproc)
  - |
    if [ $TRAVIS_OS_NAME = linux ] && [ $CC = clang ] ; then 
      make install DESTDIR=$(readlink -f appdir)
      apt download libmp3lame0 libmpg123-0 libfaac0 libfdk-aac0 libfaad2 libflac8 libmp4v2-2 libogg0 libopus0 librubberband2 libsamplerate0 libsndfile1 libspeex1 libvorbis0a libvorbisenc2 musepack-tools wavpack
      ( cd appdir/ ; dpkg-deb -x ./*deb . )
      mkdir -p appdir/usr/lib ; cp -r /usr/lib/boca appdir/usr/lib
      install -Dm 0755 /usr/bin/smooth-translator appdir/usr/bin/smooth-translator
      install -Dm 0755 packaging/appimage/AppRun appdir/AppRun
      install -Dm 0755 /usr/bin/avprobe appdir/usr/bin/avprobe
      install -Dm 0755 /usr/bin/avconv appdir/usr/bin/avconv
      find appdir/
      wget -c -nv "https://github.com/probonopd/linuxdeployqt/releases/download/continuous/linuxdeployqt-continuous-x86_64.AppImage"
      chmod a+x linuxdeployqt-continuous-x86_64.AppImage
      ./linuxdeployqt-continuous-x86_64.AppImage appdir/usr/share/applications/*.desktop -appimage \
      -executable=appdir/usr/lib/freac/freac.so -executable=appdir/usr/bin/smooth-translator \
      -executable=appdir/usr/bin/freaccmd \
      -executable=appdir/usr/lib/boca/boca_verifier_md5.1.0.so \
      -executable=appdir/usr/lib/boca/boca_tagger_vorbis.1.0.so \
      -executable=appdir/usr/lib/boca/boca_tagger_riff.1.0.so \
      -executable=appdir/usr/lib/boca/boca_tagger_mp4.1.0.so \
      -executable=appdir/usr/lib/boca/boca_tagger_id3v2.1.0.so \
      -executable=appdir/usr/lib/boca/boca_tagger_id3v1.1.0.so \
      -executable=appdir/usr/lib/boca/boca_tagger_flac.1.0.so \
      -executable=appdir/usr/lib/boca/boca_tagger_cart.1.0.so \
      -executable=appdir/usr/lib/boca/boca_tagger_apev2.1.0.so \
      -executable=appdir/usr/lib/boca/boca_playlist_xspf.1.0.so \
      -executable=appdir/usr/lib/boca/boca_playlist_wpl.1.0.so \
      -executable=appdir/usr/lib/boca/boca_playlist_vclt.1.0.so \
      -executable=appdir/usr/lib/boca/boca_playlist_pls.1.0.so \
      -executable=appdir/usr/lib/boca/boca_playlist_m3u.1.0.so \
      -executable=appdir/usr/lib/boca/boca_playlist_cuesheet.1.0.so \
      -executable=appdir/usr/lib/boca/boca_output_alsa.1.0.so \
      -executable=appdir/usr/lib/boca/boca_extension_statustime.1.0.so \
      -executable=appdir/usr/lib/boca/boca_encoder_vorbis.1.0.so \
      -executable=appdir/usr/lib/boca/boca_encoder_voaacenc.1.0.so \
      -executable=appdir/usr/lib/boca/boca_encoder_speex.1.0.so \
      -executable=appdir/usr/lib/boca/boca_encoder_sndfile.1.0.so \
      -executable=appdir/usr/lib/boca/boca_encoder_opus.1.0.so \
      -executable=appdir/usr/lib/boca/boca_encoder_meh.1.0.so \
      -executable=appdir/usr/lib/boca/boca_encoder_mac.1.0.so \
      -executable=appdir/usr/lib/boca/boca_encoder_lame.1.0.so \
      -executable=appdir/usr/lib/boca/boca_encoder_flac.1.0.so \
      -executable=appdir/usr/lib/boca/boca_encoder_fdkaac.1.0.so \
      -executable=appdir/usr/lib/boca/boca_encoder_faac.1.0.so \
      -executable=appdir/usr/lib/boca/boca_dsp_rubberband.1.0.so \
      -executable=appdir/usr/lib/boca/boca_dsp_rnnoise.1.0.so \
      -executable=appdir/usr/lib/boca/boca_dsp_resample.1.0.so \
      -executable=appdir/usr/lib/boca/boca_dsp_format.1.0.so \
      -executable=appdir/usr/lib/boca/boca_dsp_channels.1.0.so \
      -executable=appdir/usr/lib/boca/boca_deviceinfo_cdio.1.0.so \
      -executable=appdir/usr/lib/boca/boca_decoder_vorbis.1.0.so \
      -executable=appdir/usr/lib/boca/boca_decoder_speex.1.0.so \
      -executable=appdir/usr/lib/boca/boca_decoder_sndfile.1.0.so \
      -executable=appdir/usr/lib/boca/boca_decoder_opus.1.0.so \
      -executable=appdir/usr/lib/boca/boca_decoder_mpg123.1.0.so \
      -executable=appdir/usr/lib/boca/boca_decoder_mad.1.0.so \
      -executable=appdir/usr/lib/boca/boca_decoder_mac.1.0.so \
      -executable=appdir/usr/lib/boca/boca_decoder_lame.1.0.so \
      -executable=appdir/usr/lib/boca/boca_decoder_flac.1.0.so \
      -executable=appdir/usr/lib/boca/boca_decoder_fdkaac.1.0.so \
      -executable=appdir/usr/lib/boca/boca_decoder_faad2.1.0.so \
      -executable=appdir/usr/lib/boca/boca_decoder_cuesheet.1.0.so \
      -executable=appdir/usr/lib/boca/boca_decoder_cdio.1.0.so \
      -executable=appdir/usr/lib/boca/boca.1.0.so \
      -executable=appdir/usr/bin/avconv \
      -executable=appdir/usr/bin/avprobe \
      -executable=appdir/usr/lib/x86_64-linux-gnu/libvorbisenc.so.2.0.11 \
      -executable=appdir/usr/lib/x86_64-linux-gnu/libvorbis.so.0.4.8 \
      -executable=appdir/usr/lib/x86_64-linux-gnu/libspeex.so.1.5.0 \
      -executable=appdir/usr/lib/x86_64-linux-gnu/libsndfile.so.1.0.28 \
      -executable=appdir/usr/lib/x86_64-linux-gnu/libsamplerate.so.0.1.8 \
      -executable=appdir/usr/lib/x86_64-linux-gnu/librubberband.so.2.1.0 \
      -executable=appdir/usr/lib/x86_64-linux-gnu/libopus.so.0.5.2 \
      -executable=appdir/usr/lib/x86_64-linux-gnu/libogg.so.0.8.2 \
      -executable=appdir/usr/lib/x86_64-linux-gnu/libmpg123.so.0.44.8 \
      -executable=appdir/usr/lib/x86_64-linux-gnu/libmp4v2.so.2.0.0 \
      -executable=appdir/usr/lib/x86_64-linux-gnu/libmp3lame.so.0.0.0 \
      -executable=appdir/usr/lib/x86_64-linux-gnu/libFLAC.so.8.3.0 \
      -executable=appdir/usr/lib/x86_64-linux-gnu/libfaad_drm.so.2.0.0 \
      -executable=appdir/usr/lib/x86_64-linux-gnu/libfaad.so.2.0.0 \
      -executable=appdir/usr/lib/x86_64-linux-gnu/libfaac_drm.so.0.0.0 \
      -executable=appdir/usr/lib/x86_64-linux-gnu/libfaac.so.0.0.0
      wget -c https://github.com/probonopd/uploadtool/raw/master/upload.sh
      bash upload.sh fre*.AppImage*
    fi

branches:
  except:
    - # Do not build tags that we create when we upload to GitHub Releases
    - /^(?i:continuous)/
